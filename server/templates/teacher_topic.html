<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teacher Topic View</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-100 text-slate-900">
    <main class="mx-auto w-full max-w-3xl px-4 py-6 sm:px-6 sm:py-10">
      <section id="poll-container"></section>

      <footer class="mt-4 flex items-center justify-between gap-3">
        <button
          id="prev-btn"
          type="button"
          class="rounded-xl border border-slate-300 bg-white px-5 py-3 text-lg font-semibold shadow-sm transition hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-40"
          aria-label="{{ ui.teacher_prev_aria }}"
        >
          ← {{ ui.teacher_previous }}
        </button>
        <p id="position" class="text-sm font-medium text-slate-600">0 / 0</p>
        <button
          id="next-btn"
          type="button"
          class="rounded-xl border border-slate-300 bg-white px-5 py-3 text-lg font-semibold shadow-sm transition hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-40"
          aria-label="{{ ui.teacher_next_aria }}"
        >
          {{ ui.teacher_next }} →
        </button>
      </footer>
    </main>

    <script>
      const subjectId = {{ subject_id|tojson }};
      const topicId = {{ topic_id|tojson }};
      const runId = {{ run_id|tojson }};
      const apiUrl = `/api/teacher/${encodeURIComponent(subjectId)}/${encodeURIComponent(topicId)}/results?id=${encodeURIComponent(runId)}`;
      const activeApiUrl = `/api/teacher/${encodeURIComponent(subjectId)}/${encodeURIComponent(topicId)}/active?id=${encodeURIComponent(runId)}`;
      const ui = {{ ui|tojson }};

      const pollContainer = document.getElementById("poll-container");
      const prevBtn = document.getElementById("prev-btn");
      const nextBtn = document.getElementById("next-btn");
      const positionEl = document.getElementById("position");

      let polls = [];
      let currentIndex = 0;

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function renderSingleChoice(options) {
        if (!options.length) {
          return `<p class="text-sm text-slate-500">${escapeHtml(ui.teacher_no_options)}</p>`;
        }

        return options
          .map((option) => {
            const pct = Number(option.percentage || 0);
            const safePct = Math.max(0, Math.min(100, pct));
            return `
              <div>
                <div class="mb-1 flex items-center justify-between text-sm font-medium text-slate-700">
                  <span>${escapeHtml(option.label)}</span>
                  <span>${option.count} (${safePct.toFixed(1)}%)</span>
                </div>
                <div class="h-16 w-full overflow-hidden bg-slate-200">
                  <div class="h-full bg-blue-600 transition-all duration-500" style="width:${safePct}%;"></div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      function renderWordCloud(terms) {
        if (!terms.length) {
          return `<p class="text-sm text-slate-500">${escapeHtml(ui.teacher_no_text)}</p>`;
        }

        const maxCount = Math.max(...terms.map((t) => t.count), 1);
        const minSize = 14;
        const maxSize = 46;

        const words = terms
          .map((term) => {
            const ratio = maxCount === 1 ? 1 : (term.count - 1) / (maxCount - 1);
            const size = Math.round(minSize + ratio * (maxSize - minSize));
            return `<span class="inline-block px-1 font-semibold text-blue-800" style="font-size:${size}px;line-height:1.2;">${escapeHtml(term.term)}</span>`;
          })
          .join(" ");

        return `<div class="rounded-xl bg-slate-50 p-3 sm:p-4">${words}</div>`;
      }

      function renderCurrentPoll() {
        if (!polls.length) {
          pollContainer.innerHTML = `<article class="rounded-2xl border border-slate-200 bg-white p-6 text-slate-600 shadow-sm">${escapeHtml(ui.teacher_no_polls)}</article>`;
          positionEl.textContent = "0 / 0";
          prevBtn.disabled = true;
          nextBtn.disabled = true;
          return;
        }

        if (currentIndex >= polls.length) {
          currentIndex = polls.length - 1;
        }
        if (currentIndex < 0) {
          currentIndex = 0;
        }

        const poll = polls[currentIndex];
        const responseLabel = poll.total_responses === 1 ? ui.teacher_response_one : ui.teacher_response_other;
        const details =
          poll.answer_type === "single_choice" || poll.answer_type === "multiple_choice"
            ? renderSingleChoice(poll.options || [])
            : poll.answer_type === "text"
              ? renderWordCloud(poll.terms || [])
              : `<p class="text-sm text-rose-600">${escapeHtml(ui.teacher_unsupported_poll_type)}</p>`;

        pollContainer.innerHTML = `
          <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm sm:p-6">
            <div class="mb-4 flex items-start justify-between gap-3">
              <h2 class="text-lg font-semibold text-slate-900 sm:text-xl">${escapeHtml(poll.question)}</h2>
              <div class="rounded-full bg-slate-100 px-3 py-1 text-xs font-medium text-slate-700 whitespace-nowrap">${poll.total_responses} ${escapeHtml(responseLabel)}</div>
            </div>
            ${details}
          </article>
        `;

        positionEl.textContent = `${currentIndex + 1} / ${polls.length}`;
        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex === polls.length - 1;
      }

      async function setActivePoll(pollId) {
        await fetch(activeApiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ poll_id: pollId }),
        });
      }

      async function fetchResults() {
        try {
          const response = await fetch(apiUrl, { cache: "no-store" });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          polls = data.polls || [];
          const activePollId = data.active_poll_id;

          if (activePollId) {
            const activeIndex = polls.findIndex((poll) => poll.poll_id === activePollId);
            if (activeIndex >= 0) {
              currentIndex = activeIndex;
            }
          }

          renderCurrentPoll();
        } catch (error) {
          pollContainer.innerHTML = `<article class="rounded-2xl border border-rose-200 bg-rose-50 p-6 text-rose-700 shadow-sm">${escapeHtml(ui.teacher_failed_to_load)}</article>`;
          positionEl.textContent = "0 / 0";
          prevBtn.disabled = true;
          nextBtn.disabled = true;
        }
      }

      prevBtn.addEventListener("click", () => {
        if (currentIndex > 0) {
          currentIndex -= 1;
          setActivePoll(polls[currentIndex].poll_id);
          renderCurrentPoll();
        }
      });

      nextBtn.addEventListener("click", () => {
        if (currentIndex < polls.length - 1) {
          currentIndex += 1;
          setActivePoll(polls[currentIndex].poll_id);
          renderCurrentPoll();
        }
      });

      fetchResults();
      setInterval(fetchResults, 2000);
    </script>
  </body>
</html>
