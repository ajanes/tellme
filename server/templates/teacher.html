<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teacher Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-100 text-slate-900">
    <main class="mx-auto w-full max-w-5xl px-4 py-6 sm:px-6 sm:py-10">
      <section id="dashboard" class="space-y-4 sm:space-y-6"></section>
    </main>

    <script>
      const dashboardEl = document.getElementById("dashboard");

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function renderSingleChoice(options) {
        if (!options.length) {
          return '<p class="text-sm text-slate-500">No options configured.</p>';
        }

        return options
          .map((option) => {
            const pct = Number(option.percentage || 0);
            const safePct = Math.max(0, Math.min(100, pct));
            return `
              <div>
                <div class="mb-1 flex items-center justify-between text-sm font-medium text-slate-700">
                  <span>${escapeHtml(option.label)}</span>
                  <span>${option.count} (${safePct.toFixed(1)}%)</span>
                </div>
                <div class="h-16 w-full overflow-hidden bg-slate-200">
                  <div class="h-full bg-blue-600 transition-all duration-500" style="width: ${safePct}%;"></div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      function renderWordCloud(terms) {
        if (!terms.length) {
          return '<p class="text-sm text-slate-500">No text answers yet.</p>';
        }

        const maxCount = Math.max(...terms.map((term) => term.count), 1);
        const minSize = 14;
        const maxSize = 46;

        const words = terms
          .map((term) => {
            const ratio = maxCount === 1 ? 1 : (term.count - 1) / (maxCount - 1);
            const size = Math.round(minSize + ratio * (maxSize - minSize));
            return `<span class="inline-block px-1 font-semibold text-blue-800" style="font-size:${size}px;line-height:1.2;">${escapeHtml(term.term)}</span>`;
          })
          .join(" ");

        return `<div class="rounded-xl bg-slate-50 p-3 sm:p-4">${words}</div>`;
      }

      function renderPollCard(poll) {
        const meta = `${poll.subject} / ${poll.topic} / ${poll.poll_id}`;
        const responseLabel = poll.total_responses === 1 ? "response" : "responses";
        const details =
          poll.answer_type === "single_choice" || poll.answer_type === "multiple_choice"
            ? renderSingleChoice(poll.options || [])
            : poll.answer_type === "text"
              ? renderWordCloud(poll.terms || [])
              : '<p class="text-sm text-rose-600">Unsupported poll type.</p>';

        return `
          <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm sm:p-6">
            <div class="mb-4 flex flex-wrap items-start justify-between gap-2">
              <div>
                <h2 class="text-lg font-semibold text-slate-900 sm:text-xl">${escapeHtml(poll.question)}</h2>
                <p class="mt-1 text-xs text-slate-500">${escapeHtml(meta)}</p>
              </div>
              <div class="rounded-full bg-slate-100 px-3 py-1 text-xs font-medium text-slate-700">
                ${poll.total_responses} ${responseLabel}
              </div>
            </div>
            ${details}
          </article>
        `;
      }

      async function fetchResults() {
        try {
          const response = await fetch("/api/teacher/results", { cache: "no-store" });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const data = await response.json();
          const polls = data.polls || [];

          if (!polls.length) {
            dashboardEl.innerHTML = '<p class="rounded-2xl border border-slate-200 bg-white p-6 text-slate-600">No polls found.</p>';
          } else {
            dashboardEl.innerHTML = polls.map(renderPollCard).join("");
          }

        } catch (error) {
          dashboardEl.innerHTML = '<p class="rounded-2xl border border-rose-200 bg-rose-50 p-6 text-rose-700">Failed to load live results.</p>';
        }
      }

      fetchResults();
      setInterval(fetchResults, 2000);
    </script>
  </body>
</html>
